// FILE: src/main/java/fr/univ/bomberman/controller/MenuController.java
package fr.univ.bomberman.controller;

import fr.univ.bomberman.BombermanApp;
import fr.univ.bomberman.exceptions.BombermanException;
import fr.univ.bomberman.utils.ProfileManager;
import fr.univ.bomberman.model.PlayerProfile;

import javafx.event.ActionEvent;
import javafx.fxml.FXML;
import javafx.fxml.FXMLLoader;
import javafx.scene.Node;
import javafx.scene.Parent;
import javafx.scene.Scene;
import javafx.scene.control.*;
import javafx.stage.Modality;
import javafx.stage.Stage;

import java.util.List;
import java.util.Optional;

/**
 * Contr√¥leur pour le menu principal avec support avanc√© des profils.
 */
public class MenuController {

    private BombermanApp bombermanApp;
    private String player1Name = "Joueur 1";
    private String player2Name = "Joueur 2";
    private PlayerProfile currentProfile; // ‚úÖ NOUVEAU: Profil actuellement s√©lectionn√©

    // ‚úÖ AJOUT DES R√âF√âRENCES AUX NOUVEAUX BOUTONS
    @FXML private Button ctfButton;
    @FXML private Button botButton;
    @FXML private Button fourPlayerButton;
    @FXML private Button profileButton;
    @FXML private Button selectProfileButton;
    @FXML private Button globalStatsButton;

    // ‚úÖ NOUVEAU: Label pour afficher le profil actuel
    @FXML private Label currentProfileLabel;

    /**
     * Initialisation du contr√¥leur
     */
    @FXML
    public void initialize() {
        updateCurrentProfileDisplay();
        System.out.println("MenuController initialis√© avec gestion avanc√©e des profils");
    }

    /**
     * D√©finit la r√©f√©rence vers l'application principale
     */
    public void setBombermanApp(BombermanApp app) {
        this.bombermanApp = app;
    }

    /**
     * ‚úÖ NOUVELLE M√âTHODE: Met √† jour l'affichage du profil actuel
     */
    private void updateCurrentProfileDisplay() {
        if (currentProfileLabel != null) {
            if (currentProfile != null) {
                currentProfileLabel.setText("üë§ " + currentProfile.getPlayerName() +
                        " (" + currentProfile.getRank().getDisplayName() + ")");
                currentProfileLabel.setStyle("-fx-text-fill: #27ae60; -fx-font-weight: bold;");
            } else {
                currentProfileLabel.setText("üë§ Aucun profil s√©lectionn√©");
                currentProfileLabel.setStyle("-fx-text-fill: #e74c3c;");
            }
        }
    }

    /**
     * ‚úÖ M√âTHODE AM√âLIOR√âE: Gestion de profil avec nouvelle interface
     */
    @FXML
    private void onProfile() {
        openProfileSelection();
    }

    /**
     * ‚úÖ M√âTHODE AM√âLIOR√âE: S√©lection de profil avec nouvelle interface
     */
    @FXML
    private void onSelectProfile() {
        openProfileSelection();
    }

    /**
     * ‚úÖ NOUVELLE M√âTHODE: Ouvre l'interface de s√©lection de profils
     */
    private void openProfileSelection() {
        try {
            FXMLLoader loader = new FXMLLoader();
            loader.setLocation(getClass().getResource("/fr/univ/bomberman/fxml/profile/profile_selection.fxml"));
            Parent root = loader.load();

            ProfileSelectionController controller = loader.getController();
            controller.setBombermanApp(bombermanApp);

            Stage stage = new Stage();
            stage.setTitle("üéÆ Gestion des Profils - Super Bomberman");
            stage.setScene(new Scene(root, 700, 600));
            stage.initModality(Modality.APPLICATION_MODAL);
            stage.setResizable(true);

            // Centrer la fen√™tre
            if (bombermanApp != null && bombermanApp.getPrimaryStage() != null) {
                Stage primaryStage = bombermanApp.getPrimaryStage();
                stage.initOwner(primaryStage);
                stage.setX(primaryStage.getX() + (primaryStage.getWidth() - 900) / 2);
                stage.setY(primaryStage.getY() + (primaryStage.getHeight() - 600) / 2);
            }

            stage.showAndWait();

            // R√©cup√©rer le profil s√©lectionn√©
            if (controller.isProfileSelected()) {
                currentProfile = controller.getSelectedProfile();
                updateCurrentProfileDisplay();

                // Message de confirmation
                showInfo("Profil s√©lectionn√©",
                        "‚úÖ Profil actif: " + currentProfile.getPlayerName() + "\n" +
                                "üèÜ Rang: " + currentProfile.getRank().getDisplayName() + "\n" +
                                "üéÆ Parties jou√©es: " + currentProfile.getTotalGamesPlayed() + "\n" +
                                "üìä Taux de victoire: " + String.format("%.1f%%", currentProfile.getWinRatio()));

                // Appliquer les pr√©f√©rences du profil
                applyProfilePreferences();
            }

        } catch (Exception e) {
            e.printStackTrace();
            showError("Erreur", "Impossible d'ouvrir la gestion des profils: " + e.getMessage());
        }
    }

    /**
     * ‚úÖ NOUVELLE M√âTHODE: Applique les pr√©f√©rences du profil s√©lectionn√©
     */
    private void applyProfilePreferences() {
        if (currentProfile == null) return;

        try {
            // Mettre √† jour les noms par d√©faut avec le profil
            player1Name = currentProfile.getPlayerName();
            player2Name = "Adversaire"; // Nom par d√©faut pour le second joueur

            // Autres pr√©f√©rences pourraient √™tre appliqu√©es ici
            // (th√®me, son, etc.)

            System.out.println("Pr√©f√©rences appliqu√©es pour: " + currentProfile.getPlayerName());

        } catch (Exception e) {
            System.err.println("Erreur lors de l'application des pr√©f√©rences: " + e.getMessage());
        }
    }

    /**
     * ‚úÖ M√âTHODE CORRIG√âE: Statistiques globales am√©lior√©es
     */
    @FXML
    private void onGlobalStats() {
        try {
            ProfileManager profileManager = ProfileManager.getInstance();
            List<String> profiles = profileManager.listProfiles();

            if (profiles.isEmpty()) {
                showInfo("Aucune statistique",
                        "üö´ Aucun profil trouv√©\n\n" +
                                "Cr√©ez des profils et jouez des parties pour g√©n√©rer des statistiques.");
                return;
            }

            ProfileManager.ProfileStats globalStats = profileManager.getGlobalStats();

            StringBuilder message = new StringBuilder();
            message.append("üìä STATISTIQUES GLOBALES BOMBERMAN\n");
            message.append("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n");

            message.append("üë• Profils cr√©√©s: ").append(globalStats.getTotalProfiles()).append("\n");
            message.append("üéÆ Parties totales: ").append(globalStats.getTotalGamesPlayed()).append("\n");
            message.append("üèÜ Victoires totales: ").append(globalStats.getTotalWins()).append("\n");
            message.append("üìà Taux de victoire global: ").append(String.format("%.1f%%", globalStats.getGlobalWinRate())).append("\n");
            message.append("‚è±Ô∏è Temps de jeu total: ").append(globalStats.getFormattedTotalPlayTime()).append("\n\n");

            message.append("üî• TOP JOUEUR:\n");
            message.append("üë§ ").append(globalStats.getMostActivePlayer()).append("\n");
            message.append("üéÆ ").append(globalStats.getMostGamesPlayed()).append(" parties jou√©es\n\n");

            // Ajouter le top 3 si plusieurs profils
            if (profiles.size() > 1) {
                message.append("üèÜ CLASSEMENT PAR TAUX DE VICTOIRE:\n");

                // Charger et trier les profils par taux de victoire
                profiles.stream()
                        .map(name -> {
                            try {
                                return profileManager.loadProfile(name);
                            } catch (BombermanException e) {
                                return null;
                            }
                        })
                        .filter(profile -> profile != null && profile.getTotalGamesPlayed() > 0)
                        .sorted((p1, p2) -> Double.compare(p2.getWinRatio(), p1.getWinRatio()))
                        .limit(3)
                        .forEach(profile -> {
                            String rank = "ü•á";
                            if (message.toString().contains("ü•á")) rank = "ü•à";
                            if (message.toString().contains("ü•à")) rank = "ü•â";

                            message.append(rank).append(" ").append(profile.getPlayerName())
                                    .append(" - ").append(String.format("%.1f%%", profile.getWinRatio()))
                                    .append(" (").append(profile.getTotalGamesPlayed()).append(" parties)\n");
                        });
            }

            Alert alert = new Alert(Alert.AlertType.INFORMATION);
            alert.setTitle("üìä Statistiques Globales");
            alert.setHeaderText("R√©capitulatif de tous les profils");
            alert.setContentText(message.toString());
            alert.getDialogPane().setPrefWidth(500);
            alert.getDialogPane().setPrefHeight(400);
            alert.setResizable(true);
            alert.showAndWait();

        } catch (Exception e) {
            e.printStackTrace();
            showError("Erreur", "Impossible de charger les statistiques globales: " + e.getMessage());
        }
    }

    /**
     * ‚úÖ NOUVELLE M√âTHODE: Obtient le nom du joueur (depuis profil ou saisie)
     */
    private String getPlayerNameForGame() {
        if (currentProfile != null) {
            // Utiliser le profil s√©lectionn√©
            return currentProfile.getPlayerName();
        } else {
            // Demander le nom
            TextInputDialog nameDialog = new TextInputDialog("Joueur");
            nameDialog.setTitle("Nom du joueur");
            nameDialog.setHeaderText("üí° Conseil: S√©lectionnez un profil pour sauvegarder vos statistiques !");
            nameDialog.setContentText("Votre nom:");

            Optional<String> nameResult = nameDialog.showAndWait();
            if (!nameResult.isPresent() || nameResult.get().trim().isEmpty()) {
                return null; // Annul√©
            }

            String playerName = nameResult.get().trim();
            if (playerName.length() > 15) {
                showError("Nom trop long", "Maximum 15 caract√®res");
                return null;
            }

            return playerName;
        }
    }

    /**
     * ‚úÖ NOUVELLE M√âTHODE: Lance CTF avec gestion de profil
     */
    private void startCTFGameWithProfile() {
        try {
            // Demander le nombre de joueurs
            Alert playerCountAlert = new Alert(Alert.AlertType.CONFIRMATION);
            playerCountAlert.setTitle("Nombre de joueurs CTF");
            playerCountAlert.setHeaderText("üèÅ Combien de joueurs pour le CTF ?");
            playerCountAlert.setContentText("Plus il y a de joueurs, plus c'est strat√©gique !");

            ButtonType twoPlayers = new ButtonType("üë• 2 Joueurs");
            ButtonType threePlayers = new ButtonType("üë•üë§ 3 Joueurs");
            ButtonType fourPlayers = new ButtonType("üë•üë• 4 Joueurs");
            ButtonType cancel = new ButtonType("Annuler");

            playerCountAlert.getButtonTypes().setAll(twoPlayers, threePlayers, fourPlayers, cancel);

            Optional<ButtonType> countResult = playerCountAlert.showAndWait();
            if (!countResult.isPresent() || countResult.get() == cancel) {
                return;
            }

            int playerCount = 2;
            if (countResult.get() == threePlayers) playerCount = 3;
            else if (countResult.get() == fourPlayers) playerCount = 4;

            // Obtenir les noms des joueurs (avec profil pour le premier)
            String[] playerNames = getCTFPlayerNamesWithProfile(playerCount);
            if (playerNames == null) return; // Annul√©

            // Confirmer le lancement
            Alert confirmAlert = new Alert(Alert.AlertType.CONFIRMATION);
            confirmAlert.setTitle("üèÅ Lancement CTF");
            confirmAlert.setHeaderText("Capture the Flag - Configuration finale");

            StringBuilder content = new StringBuilder();
            content.append("üéÆ Mode: Capture the Flag\n");
            content.append("üë• Joueurs: ").append(playerCount).append("\n\n");

            String[] emojis = {"üî¥", "üîµ", "üü°", "üü¢"};
            String[] controls = {"ZQSD + A", "‚Üë‚Üì‚Üê‚Üí + ENTR√âE", "IJKL + U", "8456 + 7"};

            for (int i = 0; i < playerCount; i++) {
                content.append(emojis[i]).append(" ").append(playerNames[i]);
                if (i == 0 && currentProfile != null) {
                    content.append(" (üë§ Profil)");
                }
                content.append(" (").append(controls[i]).append(")\n");
            }

            content.append("\nüéØ Capturez tous les drapeaux pour gagner !");
            content.append("\nüíÄ Les √©limin√©s peuvent encore bombarder !");

            confirmAlert.setContentText(content.toString());

            Optional<ButtonType> confirmResult = confirmAlert.showAndWait();
            if (confirmResult.isPresent() && confirmResult.get() == ButtonType.OK) {
                if (bombermanApp != null) {
                    bombermanApp.startCTFGame(playerNames);
                } else {
                    showError("Erreur", "R√©f√©rence vers l'application non trouv√©e");
                }
            }

        } catch (Exception e) {
            e.printStackTrace();
            showError("Erreur CTF", "Erreur lors du lancement CTF: " + e.getMessage());
        }
    }

    /**
     * ‚úÖ NOUVELLE M√âTHODE: Lance 4 joueurs avec gestion de profil
     */
    private void start4PlayerGameWithProfile() {
        try {
            // Demander les noms des 4 joueurs (avec profil pour le premier)
            String[] playerNames = get4PlayerNamesWithProfile();
            if (playerNames == null) return; // Annul√©

            // Confirmer le lancement
            Alert confirmAlert = new Alert(Alert.AlertType.CONFIRMATION);
            confirmAlert.setTitle("Bataille Royale 4 Joueurs");
            confirmAlert.setHeaderText("‚öîÔ∏è PR√äT POUR LA BATAILLE ? ‚öîÔ∏è");

            StringBuilder content = new StringBuilder();
            content.append("Joueurs:\n");
            content.append("üî¥ ").append(playerNames[0]);
            if (currentProfile != null) content.append(" (üë§ Profil)");
            content.append(" (ZQSD + A)\n");
            content.append("üîµ ").append(playerNames[1]).append(" (‚Üë‚Üì‚Üê‚Üí + ENTR√âE)\n");
            content.append("üü° ").append(playerNames[2]).append(" (IJKL + U)\n");
            content.append("üü¢ ").append(playerNames[3]).append(" (8456 + 7)\n\n");
            content.append("Dernier survivant remporte tout !");

            confirmAlert.setContentText(content.toString());

            Optional<ButtonType> result = confirmAlert.showAndWait();
            if (result.isPresent() && result.get() == ButtonType.OK) {
                if (bombermanApp != null) {
                    bombermanApp.startFourPlayerGame(playerNames);
                } else {
                    showError("Erreur", "R√©f√©rence vers l'application principale non trouv√©e");
                }
            }

        } catch (Exception e) {
            e.printStackTrace();
            showError("Erreur", "Erreur lors du lancement du jeu 4 joueurs: " + e.getMessage());
        }
    }

    /**
     * ‚úÖ NOUVELLE M√âTHODE: Obtient les noms pour CTF avec profil
     */
    private String[] getCTFPlayerNamesWithProfile(int playerCount) {
        String[] names = new String[playerCount];
        String[] defaultNames = {"Strat√®ge", "Tacticien", "Commandant", "G√©n√©ral"};
        String[] descriptions = {
                "üî¥ Joueur 1 (ZQSD + A)",
                "üîµ Joueur 2 (‚Üë‚Üì‚Üê‚Üí + ENTR√âE)",
                "üü° Joueur 3 (IJKL + U)",
                "üü¢ Joueur 4 (8456 + 7)"
        };

        for (int i = 0; i < playerCount; i++) {
            if (i == 0 && currentProfile != null) {
                // Utiliser le profil pour le premier joueur
                names[i] = currentProfile.getPlayerName();
            } else {
                TextInputDialog dialog = new TextInputDialog(defaultNames[i]);
                dialog.setTitle("CTF - Joueur " + (i + 1));
                dialog.setHeaderText(descriptions[i]);
                dialog.setContentText("Nom du strat√®ge:");

                Optional<String> result = dialog.showAndWait();
                if (!result.isPresent()) {
                    return null; // Annul√©
                }

                String name = result.get().trim();
                if (name.isEmpty()) {
                    showError("Nom invalide", "Le nom ne peut pas √™tre vide !");
                    i--; // Recommencer ce joueur
                    continue;
                }

                if (name.length() > 15) {
                    showError("Nom trop long", "Maximum 15 caract√®res !");
                    i--; // Recommencer ce joueur
                    continue;
                }

                names[i] = name;
            }
        }

        // V√©rifier l'unicit√© des noms
        for (int i = 0; i < playerCount; i++) {
            for (int j = i + 1; j < playerCount; j++) {
                if (names[i].equals(names[j])) {
                    showError("Noms identiques", "Tous les joueurs doivent avoir des noms diff√©rents !");
                    return getCTFPlayerNamesWithProfile(playerCount); // Recommencer
                }
            }
        }

        return names;
    }

    /**
     * ‚úÖ NOUVELLE M√âTHODE: Obtient les noms pour 4 joueurs avec profil
     */
    private String[] get4PlayerNamesWithProfile() {
        String[] names = new String[4];
        String[] defaultNames = {"Alex", "Blake", "Charlie", "Dana"};
        String[] descriptions = {
                "üî¥ Joueur 1 (ZQSD + A)",
                "üîµ Joueur 2 (‚Üë‚Üì‚Üê‚Üí + ENTR√âE)",
                "üü° Joueur 3 (IJKL + U)",
                "üü¢ Joueur 4 (8456 + 7)"
        };

        for (int i = 0; i < 4; i++) {
            if (i == 0 && currentProfile != null) {
                // Utiliser le profil pour le premier joueur
                names[i] = currentProfile.getPlayerName();
            } else {
                TextInputDialog dialog = new TextInputDialog(defaultNames[i]);
                dialog.setTitle("Super Bomberman - Joueur " + (i + 1));
                dialog.setHeaderText(descriptions[i]);
                dialog.setContentText("Nom:");

                Optional<String> result = dialog.showAndWait();
                if (!result.isPresent()) {
                    return null; // Annul√©
                }

                String name = result.get().trim();
                if (name.isEmpty()) {
                    showError("Nom invalide", "Le nom ne peut pas √™tre vide !");
                    i--; // Recommencer ce joueur
                    continue;
                }

                if (name.length() > 15) {
                    showError("Nom trop long", "Le nom ne peut pas d√©passer 15 caract√®res !");
                    i--; // Recommencer ce joueur
                    continue;
                }

                names[i] = name;
            }
        }

        // V√©rifier que tous les noms sont diff√©rents
        for (int i = 0; i < 4; i++) {
            for (int j = i + 1; j < 4; j++) {
                if (names[i].equals(names[j])) {
                    showError("Noms identiques", "Tous les joueurs doivent avoir des noms diff√©rents !");
                    return get4PlayerNamesWithProfile(); // Recommencer compl√®tement
                }
            }
        }

        return names;
    }

    // ============================================================================
    // M√âTHODES EXISTANTES CONSERV√âES
    // ============================================================================

    @FXML
    private void onStartGame(ActionEvent event) {
        try {
            FXMLLoader loader = new FXMLLoader();
            loader.setLocation(getClass().getResource("/fr/univ/bomberman/fxml/game/mode_selection.fxml"));
            Parent root = loader.load();

            // Injecter la r√©f√©rence √† l'application
            GameModeController controller = loader.getController();
            if (controller != null) {
                controller.setBombermanApp(bombermanApp);
            }

            // Charger le CSS si disponible
            Scene scene = new Scene(root);
            try {
                scene.getStylesheets().add(getClass().getResource("/fr/univ/bomberman/css/game/mode_selection.css").toExternalForm());
            } catch (Exception cssEx) {
                System.out.println("CSS du menu de s√©lection non trouv√©, utilisation du style par d√©faut");
            }

            Stage stage = (Stage) ((Node) event.getSource()).getScene().getWindow();
            stage.setTitle("Super Bomberman - S√©lection du Mode");
            stage.setScene(scene);
            stage.setResizable(false);
            stage.show();

        } catch (Exception e) {
            e.printStackTrace();
            showError("Erreur", "Impossible d'ouvrir le menu de s√©lection: " + e.getMessage());
        }
    }

    @FXML
    private void onQuit(ActionEvent event) {
        Alert confirmAlert = new Alert(Alert.AlertType.CONFIRMATION);
        confirmAlert.setTitle("Quitter");
        confirmAlert.setHeaderText("Confirmation");
        confirmAlert.setContentText("Tu vas o√π comme √ßa ? " + "\n" + " Reste ici");

        Optional<ButtonType> result = confirmAlert.showAndWait();
        if (result.isPresent() && result.get() == ButtonType.OK) {
            Stage stage = (Stage) ((Node) event.getSource()).getScene().getWindow();
            stage.close();
        }
    }

    @FXML
    private void onPlayerNames(ActionEvent event) {
        try {
            TextInputDialog dialog1 = new TextInputDialog(player1Name);
            dialog1.setTitle("Super Bomberman - Nom du Joueur 1");
            dialog1.setHeaderText("üîµ Joueur 1 (ZQSD + ESPACE)");
            dialog1.setContentText("Entrez le nom du joueur 1:");

            Optional<String> result1 = dialog1.showAndWait();
            if (result1.isPresent() && !result1.get().trim().isEmpty()) {
                String newName1 = result1.get().trim();

                if (newName1.length() > 15) {
                    showError("Nom trop long", "Le nom ne peut pas d√©passer 15 caract√®res.");
                    return;
                }

                TextInputDialog dialog2 = new TextInputDialog(player2Name);
                dialog2.setTitle("Super Bomberman - Nom du Joueur 2");
                dialog2.setHeaderText("üü¢ Joueur 2 (Fl√®ches + ENTR√âE)");
                dialog2.setContentText("Entrez le nom du joueur 2:");

                Optional<String> result2 = dialog2.showAndWait();
                if (result2.isPresent() && !result2.get().trim().isEmpty()) {
                    String newName2 = result2.get().trim();

                    if (newName2.length() > 15) {
                        showError("Nom trop long", "Le nom ne peut pas d√©passer 15 caract√®res.");
                        return;
                    }

                    if (newName1.equals(newName2)) {
                        showError("Noms identiques", "Les deux joueurs ne peuvent pas avoir le m√™me nom.");
                        return;
                    }

                    player1Name = newName1;
                    player2Name = newName2;

                    Alert confirmAlert = new Alert(Alert.AlertType.INFORMATION);
                    confirmAlert.setTitle("Noms mis √† jour");
                    confirmAlert.setHeaderText("‚úÖ Noms des joueurs modifi√©s");
                    confirmAlert.setContentText("üîµ Joueur 1: " + player1Name + "\n" +
                            "üü¢ Joueur 2: " + player2Name + "\n\n" +
                            "Les nouveaux noms seront utilis√©s lors de la prochaine partie.");
                    confirmAlert.showAndWait();
                }
            }

        } catch (Exception e) {
            e.printStackTrace();
            showError("Erreur", "Impossible d'ouvrir la configuration des noms: " + e.getMessage());
        }
    }

    /**
     * ‚úÖ NOUVELLE M√âTHODE: Cr√©er un nouveau profil rapidement
     */
    @FXML
    private void onCreateQuickProfile() {
        try {
            TextInputDialog dialog = new TextInputDialog("NouveauJoueur");
            dialog.setTitle("üÜï Cr√©ation rapide de profil");
            dialog.setHeaderText("Cr√©er un nouveau profil");
            dialog.setContentText("Nom du profil:");

            Optional<String> result = dialog.showAndWait();
            if (result.isPresent()) {
                String name = result.get().trim();

                if (name.isEmpty()) {
                    showError("Nom invalide", "Le nom ne peut pas √™tre vide.");
                    return;
                }

                if (name.length() > 15) {
                    showError("Nom trop long", "Maximum 15 caract√®res.");
                    return;
                }

                ProfileManager profileManager = ProfileManager.getInstance();
                if (profileManager.profileExists(name)) {
                    showError("Profil existant", "Un profil avec ce nom existe d√©j√†.");
                    return;
                }

                PlayerProfile newProfile = profileManager.loadProfile(name);
                profileManager.saveProfile(newProfile);

                currentProfile = newProfile;
                updateCurrentProfileDisplay();

                showInfo("Profil cr√©√©",
                        "‚úÖ Nouveau profil cr√©√©: " + name + "\n\n" +
                                "üéÆ Pr√™t √† jouer !\n" +
                                "üìä Vos statistiques seront sauvegard√©es.");
            }

        } catch (BombermanException e) {
            showError("Erreur", "Impossible de cr√©er le profil: " + e.getMessage());
        }
    }

    // ============================================================================
    // M√âTHODES UTILITAIRES
    // ============================================================================

    private String getBotDescription(int difficulty) {
        switch (difficulty) {
            case 1:
                return "üü¢ IA D√©butante:\n" +
                        "‚Ä¢ Mouvements al√©atoires\n" +
                        "‚Ä¢ Bombes occasionnelles\n" +
                        "‚Ä¢ R√©actions lentes";

            case 2:
                return "üü° IA √âquilibr√©e:\n" +
                        "‚Ä¢ Strat√©gie de base\n" +
                        "‚Ä¢ Fuit les dangers\n" +
                        "‚Ä¢ Cible les briques";

            case 3:
                return "üî¥ IA Redoutable:\n" +
                        "‚Ä¢ Strat√©gie avanc√©e\n" +
                        "‚Ä¢ Vous traque activement\n" +
                        "‚Ä¢ R√©actions rapides\n" +
                        "‚Ä¢ Bombes tactiques";

            default:
                return "IA de niveau moyen";
        }
    }

    private void showError(String title, String message) {
        Alert alert = new Alert(Alert.AlertType.ERROR);
        alert.setTitle(title);
        alert.setHeaderText(null);
        alert.setContentText(message);
        alert.showAndWait();
    }

    private void showInfo(String title, String message) {
        Alert alert = new Alert(Alert.AlertType.INFORMATION);
        alert.setTitle(title);
        alert.setHeaderText(null);
        alert.setContentText(message);
        alert.showAndWait();
    }

    // ============================================================================
    // GETTERS POUR COMPATIBILIT√â
    // ============================================================================

    public String getPlayer1Name() {
        return currentProfile != null ? currentProfile.getPlayerName() : player1Name;
    }

    public String getPlayer2Name() {
        return player2Name;
    }

    public PlayerProfile getCurrentProfile() {
        return currentProfile;
    }

    public void setCurrentProfile(PlayerProfile profile) {
        this.currentProfile = profile;
        updateCurrentProfileDisplay();
    }

    // ‚úÖ AJOUTEZ CES M√âTHODES √Ä VOTRE MenuController.java EXISTANT

    /**
     * ‚úÖ NOUVELLE M√âTHODE: Affiche le tutoriel complet
     */
    @FXML
    private void onShowTutorial() {
        Alert tutorialAlert = new Alert(Alert.AlertType.INFORMATION);
        tutorialAlert.setTitle("üìñ Tutoriel Super Bomberman");
        tutorialAlert.setHeaderText("Guide complet pour bien commencer");

        StringBuilder tutorial = new StringBuilder();
        tutorial.append("üéØ OBJECTIF DU JEU:\n");
        tutorial.append("√âliminez vos adversaires avec des bombes tout en √©vitant les explosions !\n\n");

        tutorial.append("üéÆ CONTR√îLES DE BASE:\n");
        tutorial.append("‚Ä¢ Joueur 1: ZQSD pour se d√©placer, ESPACE pour poser une bombe\n");
        tutorial.append("‚Ä¢ Joueur 2: ‚Üë‚Üì‚Üê‚Üí pour se d√©placer, ENTR√âE pour poser une bombe\n");
        tutorial.append("‚Ä¢ T: Changer de th√®me visuel\n");
        tutorial.append("‚Ä¢ R: Red√©marrer la partie\n");
        tutorial.append("‚Ä¢ ESC: Retour au menu\n\n");

        tutorial.append("üí£ R√àGLES DES BOMBES:\n");
        tutorial.append("‚Ä¢ Les bombes explosent apr√®s 3 secondes\n");
        tutorial.append("‚Ä¢ Les explosions durent 1.5 seconde\n");
        tutorial.append("‚Ä¢ VOS PROPRES bombes vous tuent !\n");
        tutorial.append("‚Ä¢ Cooldown de 10 secondes entre chaque bombe\n");
        tutorial.append("‚Ä¢ Les explosions d√©truisent les briques mais pas les murs\n\n");

        tutorial.append("üèÜ CONDITIONS DE VICTOIRE:\n");
        tutorial.append("‚Ä¢ Mode Classique: √âliminez votre adversaire\n");
        tutorial.append("‚Ä¢ Bataille Royale: Soyez le dernier survivant\n");
        tutorial.append("‚Ä¢ CTF: Capturez tous les drapeaux adverses\n");
        tutorial.append("‚Ä¢ Contre IA: Battez l'intelligence artificielle\n\n");

        tutorial.append("üí° CONSEILS STRAT√âGIQUES:\n");
        tutorial.append("‚Ä¢ Utilisez les briques comme couverture\n");
        tutorial.append("‚Ä¢ Anticipez les mouvements adverses\n");
        tutorial.append("‚Ä¢ Attention aux explosions en cha√Æne\n");
        tutorial.append("‚Ä¢ Restez mobile, ne restez pas dans les coins\n");
        tutorial.append("‚Ä¢ Observez le cooldown de vos adversaires");

        tutorialAlert.setContentText(tutorial.toString());
        tutorialAlert.getDialogPane().setPrefWidth(600);
        tutorialAlert.getDialogPane().setPrefHeight(500);
        tutorialAlert.setResizable(true);
        tutorialAlert.showAndWait();
    }

    /**
     * ‚úÖ NOUVELLE M√âTHODE: Affiche les contr√¥les d√©taill√©s
     */
    @FXML
    private void onShowControls() {
        Alert controlsAlert = new Alert(Alert.AlertType.INFORMATION);
        controlsAlert.setTitle("üéÆ Contr√¥les D√©taill√©s");
        controlsAlert.setHeaderText("Guide complet des contr√¥les pour tous les modes");

        StringBuilder controls = new StringBuilder();
        controls.append("üë• MODE 2 JOUEURS:\n");
        controls.append("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n");
        controls.append("üîµ Joueur 1:\n");
        controls.append("‚Ä¢ Z = Monter\n");
        controls.append("‚Ä¢ Q = Aller √† gauche\n");
        controls.append("‚Ä¢ S = Descendre\n");
        controls.append("‚Ä¢ D = Aller √† droite\n");
        controls.append("‚Ä¢ ESPACE = Poser une bombe\n\n");

        controls.append("üü¢ Joueur 2:\n");
        controls.append("‚Ä¢ ‚Üë = Monter\n");
        controls.append("‚Ä¢ ‚Üê = Aller √† gauche\n");
        controls.append("‚Ä¢ ‚Üì = Descendre\n");
        controls.append("‚Ä¢ ‚Üí = Aller √† droite\n");
        controls.append("‚Ä¢ ENTR√âE = Poser une bombe\n\n");

        controls.append("üë•üë• MODE 4 JOUEURS (Bataille Royale):\n");
        controls.append("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n");
        controls.append("üî¥ Joueur 1: ZQSD + A (bombe)\n");
        controls.append("üîµ Joueur 2: ‚Üë‚Üì‚Üê‚Üí + ENTR√âE (bombe)\n");
        controls.append("üü° Joueur 3: IJKL + U (bombe)\n");
        controls.append("üü¢ Joueur 4: 8456 (pav√© num.) + 7 (bombe)\n\n");

        controls.append("ü§ñ MODE BOT:\n");
        controls.append("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n");
        controls.append("üë§ Vous: ZQSD + ESPACE\n");
        controls.append("ü§ñ IA: Contr√¥l√©e automatiquement\n\n");

        controls.append("‚å®Ô∏è CONTR√îLES G√âN√âRAUX:\n");
        controls.append("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n");
        controls.append("‚Ä¢ T = Changer de th√®me visuel\n");
        controls.append("‚Ä¢ R = Red√©marrer la partie\n");
        controls.append("‚Ä¢ ESC = Retour au menu principal\n");
        controls.append("‚Ä¢ E = Forcer la fin de partie\n\n");

        controls.append("üí° ASTUCES:\n");
        controls.append("‚Ä¢ Maintenez une direction pour mouvement continu (mode 2J)\n");
        controls.append("‚Ä¢ Une touche = un mouvement (mode 4J et CTF)\n");
        controls.append("‚Ä¢ Les cooldowns s'affichent en temps r√©el");

        controlsAlert.setContentText(controls.toString());
        controlsAlert.getDialogPane().setPrefWidth(550);
        controlsAlert.getDialogPane().setPrefHeight(600);
        controlsAlert.setResizable(true);
        controlsAlert.showAndWait();
    }

    /**
     * ‚úÖ NOUVELLE M√âTHODE: Affiche les informations sur les th√®mes
     */
    @FXML
    private void onShowThemes() {
        Alert themesAlert = new Alert(Alert.AlertType.INFORMATION);
        themesAlert.setTitle("üé® Th√®mes Visuels");
        themesAlert.setHeaderText("Personnalisez l'apparence de votre jeu");

        StringBuilder themes = new StringBuilder();
        themes.append("üé® TH√àMES DISPONIBLES:\n");
        themes.append("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n");

        themes.append("üîπ TH√àME PAR D√âFAUT:\n");
        themes.append("‚Ä¢ Style classique Bomberman\n");
        themes.append("‚Ä¢ Couleurs traditionnelles\n");
        themes.append("‚Ä¢ Adapt√© √† tous les joueurs\n\n");

        themes.append("üî∏ TH√àME POK√âMON:\n");
        themes.append("‚Ä¢ Personnages inspir√©s de Pok√©mon\n");
        themes.append("‚Ä¢ Couleurs vives et amusantes\n");
        themes.append("‚Ä¢ Parfait pour les fans d'anime\n\n");

        themes.append("‚öôÔ∏è COMMENT CHANGER DE TH√àME:\n");
        themes.append("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n");
        themes.append("‚Ä¢ En jeu: Appuyez sur la touche T\n");
        themes.append("‚Ä¢ Dans les profils: S√©lectionnez votre th√®me pr√©f√©r√©\n");
        themes.append("‚Ä¢ Le th√®me sera sauvegard√© avec votre profil\n\n");

        themes.append("üõ†Ô∏è AJOUTER VOS PROPRES TH√àMES:\n");
        themes.append("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n");
        themes.append("1. Cr√©ez un dossier dans: resources/fr/univ/bomberman/image/[nom_theme]/\n");
        themes.append("2. Ajoutez vos images (player1.png, bomb.png, etc.)\n");
        themes.append("3. Red√©marrez le jeu\n");
        themes.append("4. Votre th√®me appara√Ætra automatiquement\n\n");

        themes.append("üìù IMAGES REQUISES:\n");
        themes.append("‚Ä¢ player1.png, player2.png, player3.png, player4.png\n");
        themes.append("‚Ä¢ bomb.png, explosion.png\n");
        themes.append("‚Ä¢ wall.png, brick.png, ground.png\n\n");

        themes.append("üí° Format recommand√©: 40x40 pixels, PNG avec transparence");

        themesAlert.setContentText(themes.toString());
        themesAlert.getDialogPane().setPrefWidth(600);
        themesAlert.getDialogPane().setPrefHeight(500);
        themesAlert.setResizable(true);
        themesAlert.showAndWait();
    }

    /**
     * ‚úÖ NOUVELLE M√âTHODE: Affiche les informations sur le jeu
     */
    @FXML
    private void onAbout() {
        Alert aboutAlert = new Alert(Alert.AlertType.INFORMATION);
        aboutAlert.setTitle("‚ÑπÔ∏è √Ä propos de Super Bomberman");
        aboutAlert.setHeaderText("Informations sur le jeu");

        StringBuilder about = new StringBuilder();
        about.append("üí£ SUPER BOMBERMAN\n");
        about.append("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n");

        about.append("üéÆ VERSION: 2.0 Enhanced Edition\n");
        about.append("üë®‚Äçüíª D√âVELOPP√â AVEC: JavaFX + Maven\n");
        about.append("üìÖ DERNI√àRE MISE √Ä JOUR: 2025\n\n");

        about.append("üåü FONCTIONNALIT√âS:\n");
        about.append("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n");
        about.append("‚úÖ Mode Classique 2 joueurs\n");
        about.append("‚úÖ Bataille Royale 4 joueurs\n");
        about.append("‚úÖ Mode Capture The Flag\n");
        about.append("‚úÖ Intelligence Artificielle (3 niveaux)\n");
        about.append("‚úÖ Syst√®me de profils et statistiques\n");
        about.append("‚úÖ Th√®mes visuels personnalisables\n");
        about.append("‚úÖ Sauvegarde automatique des parties\n");
        about.append("‚úÖ Classements et rangs\n\n");

        about.append("üéØ MODES DE JEU:\n");
        about.append("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n");
        about.append("‚Ä¢ üî• Classique: Duel traditionnel\n");
        about.append("‚Ä¢ ‚öîÔ∏è Bataille Royale: Combat √† 4 joueurs\n");
        about.append("‚Ä¢ üèÅ CTF: Strat√©gie et capture\n");
        about.append("‚Ä¢ ü§ñ IA: D√©fi contre l'ordinateur\n\n");

        about.append("üìä SYST√àME DE PROFILS:\n");
        about.append("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n");
        about.append("‚Ä¢ Sauvegarde automatique des statistiques\n");
        about.append("‚Ä¢ Syst√®me de rangs et niveaux\n");
        about.append("‚Ä¢ Import/Export des profils\n");
        about.append("‚Ä¢ Pr√©f√©rences personnalis√©es\n\n");

        about.append("üèÜ RANGS DISPONIBLES:\n");
        about.append("ü•â Bronze ‚Üí ü•à Argent ‚Üí ü•á Or ‚Üí üíé Platine ‚Üí üëë Diamant\n\n");

        about.append("üí° CONSEIL: Cr√©ez un profil pour sauvegarder vos exploits !\n\n");

        about.append("üéÆ Amusez-vous bien et que le meilleur gagne ! üí•");

        aboutAlert.setContentText(about.toString());
        aboutAlert.getDialogPane().setPrefWidth(550);
        aboutAlert.getDialogPane().setPrefHeight(600);
        aboutAlert.setResizable(true);
        aboutAlert.showAndWait();
    }
}